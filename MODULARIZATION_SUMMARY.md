# 05-06 è…³æœ¬æ¨¡çµ„åŒ–é‡æ§‹ç¸½çµ
## 05-06 Scripts Modularization Refactoring Summary

### ğŸ“‹ **é‡æ§‹ç›®æ¨™èˆ‡æˆæœ (Refactoring Goals & Achievements)**

**âœ… æˆåŠŸé”æˆçš„ç›®æ¨™ï¼š**
- **æ¨¡çµ„åŒ–åˆ†é›¢**: 05å°ˆæ³¨ç´”è²æ°è¨ˆç®—ï¼Œ06å°ˆæ³¨è²¡å‹™æ‡‰ç”¨
- **æ¸…æ™°çš„è²¬ä»»åŠƒåˆ†**: å»ºæ¨¡ vs æ‡‰ç”¨çš„å®Œå…¨åˆ†é›¢
- **é †æš¢çš„æ•¸æ“šæµ**: 05 â†’ 06 çš„ç„¡ç¸«éŠœæ¥
- **å¯ç¨ç«‹åŸ·è¡Œ**: å„è…³æœ¬å¯ç¨ç«‹é‹è¡Œå’Œæ¸¬è©¦

---

### ğŸ§® **05 Script - Pure Bayesian Analysis (1,833 lines)**

**ğŸ¯ æ ¸å¿ƒå°ˆæ³¨ï¼šç´”è²æ°å»ºæ¨¡å’Œçµ±è¨ˆæ¨è«–**

#### **ä¿ç•™çš„æ ¸å¿ƒéšæ®µï¼š**
- **Phase 1-4**: PyMC ç’°å¢ƒé…ç½®å„ªåŒ–
  - æ²»æœ¬è§£æ±ºæ–¹æ¡ˆï¼šOMP_NUM_THREADSç’°å¢ƒè®Šæ•¸é…ç½®
  - GPU/JAX è‡ªå‹•åµæ¸¬èˆ‡é…ç½®
  - ç¡¬é«”è³‡æºå„ªåŒ–åˆ†é…

- **Phase 5**: æ¨¡å‹é›†åˆåˆ†æ (M = Î“_f Ã— Î“_Ï€)
  - æ¦‚ä¼¼å‡½æ•¸æ—ï¼šNormal, Student-T, Îµ-contamination
  - äº‹å‰æƒ…å¢ƒï¼šNon-informative, Weak, Optimistic, Pessimistic
  - ç³»çµ±æ€§æ¨¡å‹æ¯”è¼ƒ

- **Phase 6**: ç¶œåˆæ¨¡å‹æ¯”è¼ƒ
  - DIC/WAIC æ¨¡å‹é¸æ“‡
  - æ”¶æ–‚æ€§è¨ºæ–·
  - æœ€ä½³æ¨¡å‹è­˜åˆ¥

- **Phase 7**: ç©©å¥å¯ä¿¡å€é–“
  - å¤šé‡æ¨¡å‹ä¸ç¢ºå®šæ€§é‡åŒ–
  - Bootstrap ç©©å¥æ€§æª¢é©—
  - æ±¡æŸ“æ•æ„Ÿæ€§åˆ†æ

- **Phase 7.3**: å¢å¼·ç‰ˆå¾Œé©—é æ¸¬æª¢æŸ¥
  - å¤šæ¨¡å‹çµæ§‹åµæ¸¬
  - ç¶œåˆçµ±è¨ˆé©—è­‰
  - CLIMADAæ•¸æ“šç›¸å®¹æ€§é©—è­‰

- **Phase 7.4**: è²æ°-ä¿éšªæ¡†æ¶æ•´åˆ
  - BayesianInputAdapter è¨­è¨ˆ
  - ä¸ç¢ºå®šæ€§å‚³æ’­æ©Ÿåˆ¶
  - æ¡†æ¶éŠœæ¥æº–å‚™

- **Phase 7.5**: è²æ°æ±ºç­–ç†è«–å„ªåŒ–
  - ä¸‰ç¨®åŸºå·®é¢¨éšªå®šç¾©ï¼šçµ•å°ã€ä¸å°ç¨±ã€åŠ æ¬Šä¸å°ç¨±
  - æœŸæœ›æ•ˆç”¨æœ€å¤§åŒ–
  - Monte Carlo æ•´åˆ
  - Skill Score é›™é‡è§’è‰²ï¼šè£åˆ¤(æ¨¡å‹é¸æ“‡) + é¡§å•(åŸºå·®é¢¨éšªæ±ºç­–)

#### **æ•¸æ“šè¼¸å‡ºï¼š**
```python
# è¼¸å‡ºæª”æ¡ˆ: results/bayesian_analysis/05_pure_bayesian_results.pkl
{
    'posterior_samples': {...},           # æœ€ä½³æ¨¡å‹çš„å¾Œé©—æ¨£æœ¬
    'model_comparison': {...},            # æ¨¡å‹æ¯”è¼ƒçµæœ
    'decision_optimization': {...},       # è²æ°æ±ºç­–å„ªåŒ–
    'model_class_analysis': {...},        # æ¨¡å‹é›†åˆåˆ†æ
    'hierarchical_model': {...},          # éšå±¤æ¨¡å‹çµæœ
    'bayesian_insurance_integration': {...} # ä¿éšªæ¡†æ¶æ•´åˆ
}
```

---

### ğŸ’° **06 Script - Financial Analysis (827 lines)**

**ğŸ¯ æ ¸å¿ƒå°ˆæ³¨ï¼šè²¡å‹™å»ºæ¨¡å’Œå•†æ¥­æ‡‰ç”¨**

#### **æ–°çš„éšæ®µæ¶æ§‹ï¼š**

- **Phase 1**: VaR/CVaR ç›£ç®¡åˆè¦åˆ†æ
  - åŸºæ–¼å¾Œé©—æ¨£æœ¬çš„é¢¨éšªåˆ†å¸ƒç”Ÿæˆ
  - VaR 95%, 99%, 99.5% è¨ˆç®—
  - CVaR (Expected Shortfall) åˆ†æ
  - Solvency II SCR è¿‘ä¼¼è¨ˆç®—
  - é¢¨éšª-å ±é…¬æ•ˆç‡æŒ‡æ¨™

- **Phase 2**: é¢¨éšªè¼‰å…¥åˆ†æ
  - åƒæ•¸ä¸ç¢ºå®šæ€§è¼‰å…¥ (Parameter Uncertainty Loading)
  - éç¨‹é¢¨éšªè¼‰å…¥ (Process Risk Loading)
  - ç³»çµ±æ€§é¢¨éšªè¼‰å…¥ (Systematic Risk Loading)
  - æ¨¡å‹é¢¨éšªè¼‰å…¥ (Model Risk Loading)
  - ç›£ç®¡è³‡æœ¬è¼‰å…¥ (Regulatory Capital Loading)
  - åˆ©æ½¤è¼‰å…¥ (Profit Loading)

- **Phase 3**: æŠ€è¡“ä¿è²»è¨ˆç®—
  - ä½¿ç”¨ `insurance_analysis_refactored/` æ¡†æ¶
  - æ•´åˆ TechnicalPremiumCalculator
  - Gamma åˆ†å¸ƒç½å®³æŒ‡æ¨™æ“¬åˆ
  - å®Œæ•´ä¿è²»åˆ†è§£ï¼šExpected Payout + Risk Loading + Expenses + Profit

- **Phase 4**: å¤šç›®æ¨™å„ªåŒ–
  - è²¡å‹™ç›®æ¨™ï¼šæœ€å°åŒ–æŠ€è¡“ä¿è²»ã€VaRã€æå¤±æ¯”ç‡ã€ç¶œåˆæ¯”ç‡
  - å¸•ç´¯æ‰˜å‰æ²¿è­˜åˆ¥
  - æ•ˆç‡ç”¢å“ç¯©é¸
  - è²æ°ä¸ç¢ºå®šæ€§æ•´åˆå„ªåŒ–

- **Phase 5**: æ¬Šé‡æ•æ„Ÿæ€§åˆ†æ
  - å¤šç¨®æ¬Šé‡æƒ…å¢ƒæ¸¬è©¦
  - è²¡å‹™æŒ‡æ¨™æ¬Šè¡¡åˆ†æ
  - æ’åç©©å®šæ€§è©•ä¼°
  - æ±ºç­–æ•æ„Ÿæ€§é‡åŒ–

#### **æ•¸æ“šè¼¸å…¥ï¼š**
```python
# è¼¸å…¥æª”æ¡ˆ: results/bayesian_analysis/05_pure_bayesian_results.pkl
bayesian_results = pickle.load(...)
posterior_samples = bayesian_results['posterior_samples']  # ç”¨æ–¼é¢¨éšªè¨ˆç®—
best_model = bayesian_results['model_comparison']['best_model']  # æ¨¡å‹é¸æ“‡
```

#### **æ•¸æ“šè¼¸å‡ºï¼š**
```python
# è¼¸å‡ºæª”æ¡ˆ: results/financial_analysis/06_financial_analysis_results.pkl
{
    'regulatory_compliance': {...},      # VaR/CVaRåˆè¦çµæœ
    'risk_loading': {...},              # é¢¨éšªè¼‰å…¥åˆ†æ
    'technical_premiums': {...},        # æŠ€è¡“ä¿è²»è¨ˆç®—
    'multi_objective_optimization': {...}, # å¤šç›®æ¨™å„ªåŒ–
    'weight_sensitivity': {...},        # æ¬Šé‡æ•æ„Ÿæ€§
    'bayesian_integration': {...}       # è²æ°æ•´åˆç‹€æ…‹
}
```

---

### ğŸ”„ **æ•¸æ“šæµæ¶æ§‹ (Data Flow Architecture)**

```mermaid
graph LR
    A[05 Script<br/>Pure Bayesian] --> B[Bayesian Results<br/>pkl + json]
    B --> C[06 Script<br/>Financial Analysis]
    C --> D[Financial Results<br/>pkl + json]
    
    A1[Model Selection] --> B
    A2[Posterior Samples] --> B  
    A3[Decision Optimization] --> B
    A4[Uncertainty Quantification] --> B
    
    B --> C1[VaR/CVaR Analysis]
    B --> C2[Risk Loading]
    B --> C3[Technical Premiums]
    B --> C4[Multi-Objective Optimization]
```

**é—œéµæ•¸æ“šç§»äº¤é»ï¼š**
1. **å¾Œé©—æ¨£æœ¬** â†’ VaR/CVaRé¢¨éšªåˆ†å¸ƒç”Ÿæˆ
2. **æœ€ä½³æ¨¡å‹é¸æ“‡** â†’ æŠ€è¡“ä¿è²»è¨ˆç®—çš„åƒæ•¸åŒ–
3. **æ±ºç­–å„ªåŒ–çµæœ** â†’ å¤šç›®æ¨™å„ªåŒ–çš„åˆå§‹è§£
4. **ä¸ç¢ºå®šæ€§é‡åŒ–** â†’ é¢¨éšªè¼‰å…¥çš„åƒæ•¸ä¸ç¢ºå®šæ€§çµ„æˆ

---

### âœ… **é©—è­‰èˆ‡æ¸¬è©¦**

#### **æ•¸æ“šæµæ¸¬è©¦çµæœï¼š**
```
Testing 05 â†’ 06 Data Flow: âœ… PASSED
âœ“ File Creation: âœ…
âœ“ Data Loading: âœ…  
âœ“ Posterior Samples: âœ…
âœ“ Model Selection: âœ…
âœ“ Decision Optimization: âœ…
âœ“ Bayesian Integration: âœ…
```

#### **è…³æœ¬çµæ§‹å°æ¯”ï¼š**
| é …ç›® | 05 Script | 06 Script |
|------|-----------|-----------|
| **è¡Œæ•¸** | 1,833 lines | 827 lines |
| **å°ˆæ³¨é ˜åŸŸ** | ç´”è²æ°å»ºæ¨¡ | è²¡å‹™æ‡‰ç”¨ |
| **éšæ®µæ•¸** | 7 phases | 5 phases |
| **è¼¸å…¥ä¾è³´** | CLIMADAåŸå§‹æ•¸æ“š | 05è…³æœ¬è¼¸å‡º |
| **è¼¸å‡ºé¡å‹** | çµ±è¨ˆæ¨è«–çµæœ | è²¡å‹™æ±ºç­–æ”¯æŒ |

---

### ğŸ¯ **æ ¸å¿ƒæ¶æ§‹å„ªå‹¢**

#### **1. æ¸…æ™°è²¬ä»»åŠƒåˆ†**
- **05**: "What is the best model?" (æ¨¡å‹é¸æ“‡èˆ‡ä¸ç¢ºå®šæ€§é‡åŒ–)
- **06**: "What is the optimal financial decision?" (å•†æ¥­æ‡‰ç”¨èˆ‡æœ€ä½³åŒ–)

#### **2. ç¨ç«‹æ€§èˆ‡å¯æ¸¬è©¦æ€§**
- å„è…³æœ¬å¯ç¨ç«‹åŸ·è¡Œå’Œé™¤éŒ¯
- æ¨¡çµ„åŒ–éŒ¯èª¤éš”é›¢
- åˆ†åˆ¥é‡å°çµ±è¨ˆæ­£ç¢ºæ€§ vs å•†æ¥­å¯¦ç”¨æ€§æœ€ä½³åŒ–

#### **3. å¯æ“´å±•æ€§**
- **05**: å¯æ·»åŠ æ–°çš„è²æ°æ–¹æ³•ã€æ¨¡å‹æ—ã€è¨ºæ–·å·¥å…·
- **06**: å¯æ·»åŠ æ–°çš„è²¡å‹™æŒ‡æ¨™ã€ç›£ç®¡è¦æ±‚ã€æœ€ä½³åŒ–ç›®æ¨™

#### **4. å°ˆæ¥­åˆ†å·¥**
- **çµ±è¨ˆå­¸å®¶**: å°ˆæ³¨05è…³æœ¬çš„å»ºæ¨¡æ­£ç¢ºæ€§
- **ç²¾ç®—å¸«**: å°ˆæ³¨06è…³æœ¬çš„è²¡å‹™æ‡‰ç”¨

---

### ğŸ’¡ **é—œéµæŠ€è¡“å¯¦ç¾**

#### **Îµ-contamination çœŸæ­£æ•´åˆ**
```python
# 05 Script: çœŸæ­£æ•´åˆåˆ°éšå±¤æ¨¡å‹æ ¸å¿ƒ
Ï€(Î¸) = (1-Îµ)Ï€â‚€(Î¸) + Îµq(Î¸)  # Îµ = 3.2/365, q = Cauchy
```

#### **Skill Score é›™é‡è§’è‰²**
- **è£åˆ¤è§’è‰² (Judge)**: 05è…³æœ¬ä¸­çš„æ¨¡å‹é¸æ“‡
- **é¡§å•è§’è‰² (Advisor)**: 05è…³æœ¬ä¸­çš„åŸºå·®é¢¨éšªæ±ºç­–

#### **ä¸‰ç¨®åŸºå·®é¢¨éšªå®šç¾©**
```python
# 05 Script: è²æ°æ±ºç­–ç†è«–å„ªåŒ–
absolute: L(Î¸,a) = |Actual_Loss(Î¸) - Payout(a)|
asymmetric: L(Î¸,a) = max(0, Actual_Loss(Î¸) - Payout(a))  
weighted: L(Î¸,a) = w_under Ã— under + w_over Ã— over
```

#### **VaR/CVaR ç›£ç®¡æ•´åˆ**
```python
# 06 Script: ç›£ç®¡åˆè¦
VaR_99.5% = np.percentile(basis_risk_samples, 99.5)
CVaR_99.5% = np.mean(tail_losses[tail_losses >= VaR_99.5%])
SCR â‰ˆ VaR_99.5% Ã— market_factor + mean_risk Ã— operational_factor
```

---

### ğŸ“Š **æ•ˆèƒ½èˆ‡å¯ç¶­è­·æ€§æå‡**

#### **ç¨‹å¼ç¢¼çµ„ç¹”æ”¹å–„**
- **åŸå§‹å–®ä¸€æª”æ¡ˆ**: 2,751 lines (é›£ä»¥ç¶­è­·)
- **é‡æ§‹å¾Œé›™æª”æ¡ˆ**: 1,833 + 827 = 2,660 lines (æ¨¡çµ„åŒ–)
- **ç¨‹å¼ç¢¼é‡ç”¨**: insurance_analysis_refactored/ æ¡†æ¶æœ€å¤§åŒ–åˆ©ç”¨

#### **åŸ·è¡Œæ•ˆç‡**
- **05**: å¯ç¨ç«‹åŸ·è¡Œè²æ°åˆ†æï¼Œä¸è¼‰å…¥è²¡å‹™æ¨¡çµ„
- **06**: ç›´æ¥è®€å–05çµæœï¼Œè·³éé‡è¤‡è¨ˆç®—
- **ç¸½åŸ·è¡Œæ™‚é–“**: å¯èƒ½é™ä½ (é¿å…é‡è¤‡æ¨¡å‹æ“¬åˆ)

#### **é™¤éŒ¯èˆ‡æ¸¬è©¦**
- **å–®å…ƒæ¸¬è©¦**: å„éšæ®µå¯ç¨ç«‹æ¸¬è©¦
- **æ•´åˆæ¸¬è©¦**: test_05_to_06_flow.py é©—è­‰æ•¸æ“šæµ
- **éŒ¯èª¤éš”é›¢**: è²æ°vsè²¡å‹™éŒ¯èª¤åˆ†é›¢é™¤éŒ¯

---

### ğŸš€ **æœªä¾†ç™¼å±•æ–¹å‘**

#### **05 Script æ½›åœ¨æ“´å±•**
- æ›´å¤šæ¦‚ä¼¼å‡½æ•¸æ— (Skew-T, Generalized Error Distribution)
- é€²éš Îµ-contamination (æ™‚è®ŠÎµ, æ··åˆæ±¡æŸ“åˆ†å¸ƒ)
- ç©ºé–“-æ™‚é–“éšå±¤æ¨¡å‹
- è®Šåˆ†è²æ°æ–¹æ³• (Variational Bayes)

#### **06 Script æ½›åœ¨æ“´å±•**
- å‹•æ…‹é¢¨éšªè¼‰å…¥æ¨¡å‹
- å¯¦æ™‚ç›£ç®¡å ±å‘Šç”Ÿæˆ
- å¤šå¹£ç¨®æŠ€è¡“ä¿è²»
- ESG (Environmental, Social, Governance) æ•´åˆ

#### **æ•´åˆç™¼å±•**
- è‡ªå‹•åŒ– 05â†’06 æµæ°´ç·š
- å³æ™‚æ›´æ–°èˆ‡é‡æ–°æ ¡æº–
- ç¶²é ä»‹é¢å„€è¡¨æ¿
- API æœå‹™åŒ–éƒ¨ç½²

---

### ğŸ‰ **ç¸½çµ**

âœ… **æˆåŠŸå¯¦ç¾äº†ç”¨æˆ¶è¦æ±‚çš„å®Œç¾æ¨¡çµ„åŒ–**ï¼š
- 05å°ˆæ³¨ç´”è²æ°è¨ˆç®— âœ“
- 06å°ˆæ³¨è²¡å‹™æ‡‰ç”¨ âœ“  
- æ•¸æ“šæµé †æš¢éŠœæ¥ âœ“
- æ¶æ§‹æ¸…æ™°å¯ç¶­è­· âœ“

ğŸ—ï¸ **é€™å€‹é‡æ§‹ç‚ºåŒ—å¡ç¾…ä¾†ç´å·ç†±å¸¶æ°£æ—‹åƒæ•¸å‹ä¿éšªçš„ç ”ç©¶æä¾›äº†**ï¼š
- ç§‘å­¸åš´è¬¹çš„è²æ°å»ºæ¨¡åŸºç¤
- å•†æ¥­å¯¦ç”¨çš„è²¡å‹™æ±ºç­–æ”¯æŒ  
- å¯æ“´å±•çš„ç ”ç©¶é–‹ç™¼å¹³å°
- ç”¢å­¸å”ä½œçš„è‰¯å¥½æ¶æ§‹

ğŸ”¬ **ç¬¦åˆå­¸è¡“ç ”ç©¶çš„é«˜æ¨™æº–**ï¼š
- æ–¹æ³•è«–å‰µæ–° (Îµ-contamination + Skill Scoreé›™é‡è§’è‰²)
- çµ±è¨ˆæ­£ç¢ºæ€§ (å®Œæ•´ä¸ç¢ºå®šæ€§é‡åŒ–)
- å¯¦å‹™æ‡‰ç”¨æ€§ (ç›£ç®¡åˆè¦ + æŠ€è¡“ä¿è²»)
- å¯é‡ç¾æ€§ (æ¨¡çµ„åŒ–è¨­è¨ˆ + å®Œæ•´æ–‡æª”)